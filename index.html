<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Corrispettivi - Scontrini Elettronici</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Corrispettivi">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        body {
            background-color: #f5f6fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1a252f 100%);
            min-height: 100vh;
            padding: 0;
            position: fixed;
            width: 250px;
            z-index: 1000;
        }
        
        .sidebar .logo {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar .logo h4 {
            color: white;
            margin: 0;
            font-weight: 600;
        }
        
        .sidebar .logo small {
            color: rgba(255,255,255,0.6);
            font-size: 0.75rem;
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 15px 20px;
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: var(--secondary-color);
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px 30px;
        }
        
        .top-bar {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-card .icon.blue { background: rgba(52, 152, 219, 0.15); color: var(--secondary-color); }
        .stat-card .icon.green { background: rgba(39, 174, 96, 0.15); color: var(--success-color); }
        .stat-card .icon.orange { background: rgba(243, 156, 18, 0.15); color: var(--warning-color); }
        .stat-card .icon.red { background: rgba(231, 76, 60, 0.15); color: var(--danger-color); }
        
        .stat-card h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0 5px;
        }
        
        .stat-card p {
            color: #7f8c8d;
            margin: 0;
            font-size: 0.9rem;
        }
        
        .card-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .card-section h5 {
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .btn-primary {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-success {
            background: var(--success-color);
            border-color: var(--success-color);
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #7f8c8d;
        }
        
        .badge-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.75rem;
        }
        
        .badge-inviato { background: rgba(39, 174, 96, 0.15); color: var(--success-color); }
        .badge-pending { background: rgba(243, 156, 18, 0.15); color: var(--warning-color); }
        .badge-errore { background: rgba(231, 76, 60, 0.15); color: var(--danger-color); }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .product-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .config-alert {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: none;
            border-left: 4px solid var(--warning-color);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }
            .main-content {
                margin-left: 0;
            }
        }
        
        .hidden { display: none !important; }
        
        /* Login styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, #1a252f 100%);
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header i {
            font-size: 3rem;
            color: var(--secondary-color);
        }
        
        .login-header h3 {
            margin-top: 15px;
            color: var(--primary-color);
        }
        
        .login-header p {
            color: #7f8c8d;
        }
        
        /* Modal styling */
        .modal-header {
            background: var(--primary-color);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <i class="bi bi-receipt"></i>
                <h3>Registro Corrispettivi</h3>
                <p>Accedi per continuare</p>
            </div>
            <form id="login-form" onsubmit="return handleLogin(event)">
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="login-password" placeholder="Inserisci password" required>
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                            <i class="bi bi-eye" id="toggle-icon"></i>
                        </button>
                    </div>
                </div>
                <div id="login-error" class="alert alert-danger d-none">
                    Password non corretta
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Accedi
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP (hidden until login) -->
    <div id="main-app" class="d-none">
    <!-- Sidebar -->
    <nav class="sidebar d-flex flex-column">
        <div class="logo">
            <h4><i class="bi bi-receipt"></i> Corrispettivi</h4>
            <small>Gestione Scontrini Elettronici</small>
        </div>
        <ul class="nav flex-column mt-3">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-section="dashboard">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="nuovo-scontrino">
                    <i class="bi bi-plus-circle"></i> Nuovo Scontrino
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="registro">
                    <i class="bi bi-journal-text"></i> Registro Corrispettivi
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="resi">
                    <i class="bi bi-arrow-return-left"></i> Resi / Annullamenti
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="configurazione">
                    <i class="bi bi-gear"></i> Configurazione
                </a>
            </li>
        </ul>
        <div class="mt-auto p-3">
            <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="logout()">
                <i class="bi bi-box-arrow-left"></i> Esci
            </button>
            <div class="text-white-50 small">
                <i class="bi bi-cloud-check"></i> Connesso a OpenAPI
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div>
                <h5 class="mb-0" id="page-title">Dashboard</h5>
                <small class="text-muted" id="current-date"></small>
            </div>
            <div>
                <button class="btn btn-primary" onclick="showSection('nuovo-scontrino')">
                    <i class="bi bi-plus-lg"></i> Nuovo Scontrino
                </button>
            </div>
        </div>

        <!-- Alert Configurazione -->
        <div class="alert config-alert mb-4" id="config-alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Configurazione richiesta:</strong> Inserisci il token API e i dati fiscali nella sezione 
            <a href="#" onclick="showSection('configurazione')">Configurazione</a> per iniziare.
        </div>

        <!-- DASHBOARD SECTION -->
        <section id="section-dashboard">
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 id="stat-oggi">€ 0,00</h3>
                                <p>Incasso Oggi</p>
                            </div>
                            <div class="icon blue">
                                <i class="bi bi-cash-stack"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 id="stat-scontrini">0</h3>
                                <p>Scontrini Oggi</p>
                            </div>
                            <div class="icon green">
                                <i class="bi bi-receipt"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 id="stat-mese">€ 0,00</h3>
                                <p>Incasso Mese</p>
                            </div>
                            <div class="icon orange">
                                <i class="bi bi-calendar-month"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h3 id="stat-pending">0</h3>
                                <p>In Attesa</p>
                            </div>
                            <div class="icon red">
                                <i class="bi bi-clock-history"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card-section">
                        <h5><i class="bi bi-list-ul me-2"></i>Ultimi Scontrini</h5>
                        <div class="table-responsive">
                            <table class="table table-hover" id="table-ultimi-scontrini">
                                <thead>
                                    <tr>
                                        <th>Data/Ora</th>
                                        <th>Numero</th>
                                        <th>Importo</th>
                                        <th>Stato</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            Nessuno scontrino emesso oggi
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card-section">
                        <h5><i class="bi bi-pie-chart me-2"></i>Riepilogo IVA Oggi</h5>
                        <div id="riepilogo-iva">
                            <div class="d-flex justify-content-between py-2 border-bottom">
                                <span>IVA 22%</span>
                                <strong id="iva-22">€ 0,00</strong>
                            </div>
                            <div class="d-flex justify-content-between py-2 border-bottom">
                                <span>IVA 10%</span>
                                <strong id="iva-10">€ 0,00</strong>
                            </div>
                            <div class="d-flex justify-content-between py-2 border-bottom">
                                <span>IVA 4%</span>
                                <strong id="iva-4">€ 0,00</strong>
                            </div>
                            <div class="d-flex justify-content-between py-2">
                                <span>Esente</span>
                                <strong id="iva-0">€ 0,00</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- NUOVO SCONTRINO SECTION -->
        <section id="section-nuovo-scontrino" class="hidden">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card-section">
                        <h5><i class="bi bi-cart-plus me-2"></i>Articoli</h5>
                        <div id="lista-articoli">
                            <!-- Gli articoli verranno aggiunti qui -->
                        </div>
                        <button class="btn btn-outline-primary mt-3" onclick="aggiungiArticolo()">
                            <i class="bi bi-plus-lg"></i> Aggiungi Articolo
                        </button>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card-section">
                        <h5><i class="bi bi-calculator me-2"></i>Riepilogo</h5>
                        <div class="mb-3">
                            <label class="form-label">Metodo di Pagamento</label>
                            <select class="form-select" id="metodo-pagamento">
                                <option value="contanti">Contanti</option>
                                <option value="carta">Carta di Credito/Debito</option>
                                <option value="bancomat">Bancomat</option>
                                <option value="altro">Altro (non riscosso)</option>
                            </select>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Imponibile:</span>
                            <span id="subtotale">€ 0,00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>IVA:</span>
                            <span id="totale-iva">€ 0,00</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>TOTALE:</strong>
                            <strong class="fs-4 text-primary" id="totale">€ 0,00</strong>
                        </div>
                        <button class="btn btn-success w-100 btn-lg" onclick="emettiScontrino()">
                            <i class="bi bi-send me-2"></i>Emetti Scontrino
                        </button>
                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="annullaScontrino()">
                            Annulla
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- REGISTRO CORRISPETTIVI SECTION -->
        <section id="section-registro" class="hidden">
            <div class="card-section">
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Data Inizio</label>
                        <input type="date" class="form-control" id="filtro-data-inizio">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Fine</label>
                        <input type="date" class="form-control" id="filtro-data-fine">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Stato</label>
                        <select class="form-select" id="filtro-stato">
                            <option value="">Tutti</option>
                            <option value="inviato">Inviato</option>
                            <option value="pending">In attesa</option>
                            <option value="errore">Errore</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" onclick="filtraRegistro()">
                            <i class="bi bi-search"></i> Cerca
                        </button>
                    </div>
                </div>
                <hr>
                <h5><i class="bi bi-journal-text me-2"></i>Registro Scontrini</h5>
                <div class="table-responsive">
                    <table class="table table-hover" id="table-registro">
                        <thead>
                            <tr>
                                <th>Data/Ora</th>
                                <th>Numero Documento</th>
                                <th>Importo</th>
                                <th>Pagamento</th>
                                <th>Stato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">
                                    Nessuno scontrino trovato
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-success" onclick="esportaRegistro()">
                        <i class="bi bi-file-earmark-excel"></i> Esporta Excel
                    </button>
                    <button class="btn btn-outline-danger" onclick="esportaPDF()">
                        <i class="bi bi-file-earmark-pdf"></i> Esporta PDF
                    </button>
                </div>
            </div>
        </section>

        <!-- RESI SECTION -->
        <section id="section-resi" class="hidden">
            <div class="card-section">
                <h5><i class="bi bi-arrow-return-left me-2"></i>Gestione Resi e Annullamenti</h5>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Numero Scontrino Originale</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="scontrino-reso" placeholder="Es. 0001-2024">
                            <button class="btn btn-primary" onclick="cercaScontrino()">
                                <i class="bi bi-search"></i> Cerca
                            </button>
                        </div>
                    </div>
                </div>
                <div id="dettaglio-reso" class="hidden">
                    <!-- Dettagli scontrino per reso -->
                </div>
            </div>
        </section>

        <!-- CONFIGURAZIONE SECTION -->
        <section id="section-configurazione" class="hidden">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card-section">
                        <h5><i class="bi bi-key me-2"></i>Credenziali API</h5>
                        <div class="mb-3">
                            <label class="form-label">Token API OpenAPI</label>
                            <input type="password" class="form-control" id="api-token" placeholder="Inserisci il token OAuth">
                            <div class="form-text">
                                Ottieni il token da <a href="https://console.openapi.com/it/oauth" target="_blank">console.openapi.com</a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ambiente</label>
                            <select class="form-select" id="api-ambiente">
                                <option value="sandbox">Sandbox (Test)</option>
                                <option value="production">Produzione</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="testConnessione()">
                            <i class="bi bi-cloud-check"></i> Testa Connessione
                        </button>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card-section">
                        <h5><i class="bi bi-building me-2"></i>Dati Fiscali</h5>
                        <div class="mb-3">
                            <label class="form-label">Partita IVA</label>
                            <input type="text" class="form-control" id="partita-iva" placeholder="IT12345678901">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Codice Fiscale</label>
                            <input type="text" class="form-control" id="codice-fiscale" placeholder="RSSMRA80A01H501U">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ragione Sociale</label>
                            <input type="text" class="form-control" id="ragione-sociale" placeholder="La Mia Azienda SRL">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Indirizzo</label>
                            <input type="text" class="form-control" id="indirizzo" placeholder="Via Roma, 1 - 00100 Roma">
                        </div>
                        <button class="btn btn-success" onclick="salvaConfigurazione()">
                            <i class="bi bi-save"></i> Salva Configurazione
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Dettaglio Scontrino -->
    <div class="modal fade" id="modalDettaglio" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Dettaglio Scontrino</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-dettaglio-content">
                    <!-- Contenuto dinamico -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-danger" onclick="annullaScontrinoSelezionato()">
                        <i class="bi bi-x-circle"></i> Annulla Scontrino
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast-notification" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle me-2" id="toast-icon"></i>
                <strong class="me-auto" id="toast-title">Notifica</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message"></div>
        </div>
    </div>

    </div><!-- end main-app -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        // Registrazione Service Worker per PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrato:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registrazione fallita:', error);
                    });
            });
        }
    </script>
</body>
</html>
